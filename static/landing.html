<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Polygon Arbitrage Bot | Real-Time Monitor</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* -------------------- Base Styles -------------------- */
        body {
            margin: 0;
            font-family: 'Inter', sans-serif;
            background-color: #080a0e;
            color: #e4e7eb;
            overflow-x: hidden;
            transition: background-color 0.5s;
        }

        /* -------------------- Navigation Bar -------------------- */
        #navbar {
            position: fixed;
            top: 0;
            width: 100%;
            background-color: rgba(14, 18, 25, 0.9);
            backdrop-filter: blur(8px);
            z-index: 10;
            padding: 15px 5px; 
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #1f2a37;
        }

        #nav-links-container {
            display: flex;
            gap: 15px; 
            align-items: center;
        }

        #navbar .logo {
            font-size: 1.4rem;
            font-weight: 700;
            color: #7f5af0;
        }

        #navbar .nav-link {
            color: #c9d1d9; 
            text-decoration: none;
            padding: 8px 12px;
            border-radius: 6px;
            transition: color 0.3s, background-color 0.3s;
            font-weight: 500;
        }

        #navbar .nav-link:hover {
            color: #ffffff;
            background-color: rgba(127, 90, 240, 0.1);
        }

        /* -------------------- Common Section Styles -------------------- */
        .page-section {
            position: relative;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            overflow: hidden;
            padding-top: 80px; 
            display: none; 
        }
        
        /* -------------------- Background & Animation -------------------- */
        .bg-animation {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0f151c, #080a0e, #1f2a37, #080a0e);
            background-size: 400% 400%;
            animation: gradientShift 40s ease infinite;
            z-index: -2;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .particle {
            position: absolute;
            width: 2px;
            height: 2px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            box-shadow: 0 0 4px rgba(127, 90, 240, 0.5);
            animation: float 20s linear infinite;
            opacity: 0;
            z-index: -1;
        }

        @keyframes float {
            0% { transform: translateY(0) translateX(0); opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { transform: translateY(-100vh) translateX(50vw); opacity: 0; }
        }

        .fade-slide {
            opacity: 0;
            transform: translateY(20px);
            animation: fadeInUp 1s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        .fade-slide.delay1 { animation-delay: 0.3s; }
        .fade-slide.delay2 { animation-delay: 0.6s; }
        .fade-slide.delay3 { animation-delay: 0.9s; }
        .fade-slide.delay4 { animation-delay: 1.2s; }
        .fade-slide.delay5 { animation-delay: 1.5s; }
        .fade-slide.delay6 { animation-delay: 1.8s; }

        @keyframes fadeInUp {
            to { opacity: 1; transform: translateY(0); }
        }

        /* -------------------- Landing Section -------------------- */
        #landing {
            /* Overrides .page-section display:none, ensures flex layout */
            display: flex; 
        }

        #landing h1 {
            font-size: 3.5rem;
            margin-bottom: 10px;
            text-shadow: 0 0 20px rgba(127, 90, 240, 0.4);
            color: #ffffff;
            font-weight: 800;
        }

        #landing p {
            font-size: 1.1rem;
            margin-bottom: 40px;
            max-width: 700px;
            color: #94a3b8;
            line-height: 1.6;
        }

        #landing p strong {
            color: #fff;
            font-weight: 700;
        }

        #landing button {
            background: #7f5af0;
            border: none;
            color: white;
            padding: 14px 40px;
            font-size: 1.1rem;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 20px rgba(127, 90, 240, 0.4);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        #landing button:hover {
            background: #9673ff;
            transform: translateY(-3px);
            box-shadow: 0 8px 30px rgba(127, 90, 240, 0.6);
        }

        .key-stats {
            display: flex;
            gap: 40px;
            margin-top: 60px;
            padding: 20px 0;
            border-top: 1px solid #1f2a37;
            border-bottom: 1px solid #1f2a37;
        }

        .stat-item {
            text-align: center;
            padding: 10px 0;
        }

        .stat-item h3 {
            font-size: 2.2rem;
            color: #2ecc71;
            margin: 0;
            font-weight: 700;
        }

        .stat-item p {
            font-size: 0.9rem;
            color: #94a3b8;
            margin: 0;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        #landing footer {
            margin-top: 50px;
            font-size: 0.8rem;
            color: #525f7a;
        }
        
        /* -------------------- About Section -------------------- */
        #about {
            justify-content: flex-start; /* Align content to the top */
            padding: 120px 50px 50px 50px;
            text-align: left;
        }

        .about-container {
            max-width: 900px;
            width: 100%;
            margin: 0 auto;
            z-index: 1;
            position: relative;
        }
        
        #about h2 {
            color: #7f5af0;
            font-size: 2.5rem;
            text-align: center;
            margin-bottom: 40px;
            font-weight: 800;
            text-shadow: 0 0 10px rgba(127, 90, 240, 0.3);
        }
        
        .about-item {
            background-color: rgba(15, 21, 28, 0.7); 
            backdrop-filter: blur(4px);
            padding: 25px;
            margin-bottom: 25px;
            border-radius: 12px;
            border-left: 4px solid #7f5af0;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .about-item:hover {
            transform: translate(5px, -5px); 
            box-shadow: 0 10px 30px rgba(127, 90, 240, 0.25);
        }

        .about-item h3 {
            font-size: 1.5rem;
            color: #2ecc71;
            margin-top: 0;
            margin-bottom: 10px;
            font-weight: 700;
        }
        
        .about-item p, .about-item ul {
            font-size: 1rem;
            color: #c9d1d9;
            line-height: 1.6;
            margin: 0;
        }

        .about-item ul {
            list-style-type: none;
            padding-left: 0;
        }
        
        .about-item li {
            margin-bottom: 5px;
            padding-left: 20px;
            position: relative;
        }
        
        .about-item li::before {
            content: 'âš¡';
            color: #7f5af0;
            position: absolute;
            left: 0;
        }

        /* -------------------- Metrics Section -------------------- */
        #metrics {
            justify-content: flex-start; /* Align content to the top */
            padding: 120px 50px 50px 50px;
            text-align: center;
            background-color: #080a0e;
            display: none; /* Default state managed by JS */
        }

        .metrics-container {
            max-width: 1000px;
            width: 100%;
            margin: 0 auto;
            z-index: 1; 
            position: relative;
        }
        
        #metrics h2 {
            color: #7f5af0;
            font-size: 2.5rem;
            text-align: center;
            margin-bottom: 40px;
            font-weight: 800;
            text-shadow: 0 0 10px rgba(127, 90, 240, 0.3);
        }

        #metrics h3 {
            color: #e4e7eb;
            font-size: 1.5rem;
            margin-top: 30px;
            margin-bottom: 20px;
            font-weight: 600;
            text-align: left;
        }
        
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 25px;
            margin-bottom: 50px;
        }

        .kpi-card {
            background-color: rgba(15, 21, 28, 0.7); 
            backdrop-filter: blur(4px);
            padding: 25px;
            border-radius: 12px;
            border-bottom: 4px solid #2ecc71; /* Success color */
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            text-align: center;
        }

        .kpi-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(46, 204, 113, 0.15);
        }

        .kpi-card .value {
            font-size: 3rem;
            font-weight: 900;
            color: #2ecc71;
            margin-bottom: 5px;
        }

        .kpi-card .label {
            font-size: 1rem;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        /* -------------------- CHART FIX (THE PROBLEM AREA) -------------------- */
        .chart-wrapper {
            position: relative;
            /* FIXED HEIGHT: This stops the chart from expanding its parent container */
            height: 450px; 
            width: 100%;
            max-width: 100%;
            margin: 0 auto;
            background: #0f151c;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            margin-top: 20px;
        }

        #cumulativeProfitChart {
            /* Force the canvas to take 100% of the fixed height wrapper */
            height: 100% !important; 
            width: 100% !important; 
            /* Reset any Chart.js inline styles that conflict */
        }

        /* -------------------- Dashboard Section -------------------- */
        #dashboard {
            padding: 30px 50px;
            min-height: 100vh;
            background-color: #080a0e;
            justify-content: flex-start; /* Required override for tables/charts */
            display: none; /* Default state managed by JS */
        }

        #dashboard h2 {
            color: #7f5af0;
            text-align: center;
            margin-top: 80px;
            margin-bottom: 30px;
            font-weight: 700;
        }

        .dataTables_wrapper {
            background: #0f151c;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            margin-top: 20px;
        }
        
        table.dataTable {
            border-radius: 8px;
            overflow: hidden;
            background: #0f151c;
        }

        th {
            background: #1f2a37;
            color: #e4e7eb;
            border-bottom: 2px solid #7f5af0;
            padding: 15px 10px;
            font-weight: 600;
        }

        td {
            background: #0f151c;
            color: #c9d1d9;
            border-bottom: 1px solid #1f2a37;
            padding: 12px 10px;
            transition: background 0.3s;
        }

        tr:hover td {
            background: #161b22;
        }

        .profit-positive { color: #2ecc71; font-weight: 600; }
        .profit-negative { color: #e74c3c; font-weight: 600; }

        #profitChart {
            margin-top: 40px;
            background: #0f151c;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            max-height: 450px;
        }

        .dataTables_length, .dataTables_filter, .dataTables_info, .dataTables_paginate {
            color: #94a3b8 !important;
            padding: 10px 0;
        }

        .dataTables_wrapper .dataTables_paginate .paginate_button {
            background: #1f2a37 !important;
            color: #e4e7eb !important;
            border: 1px solid #1f2a37 !important;
            border-radius: 4px !important;
            margin: 0 3px;
            transition: background 0.3s;
        }

        .dataTables_wrapper .dataTables_paginate .paginate_button:hover {
            background: #9673ff !important;
            color: white !important;
            border-color: #9673ff !important;
        }

        .dataTables_wrapper .dataTables_paginate .paginate_button.current {
            background: #7f5af0 !important;
            color: white !important;
        }

        /* Media Queries for Responsiveness */
        @media (max-width: 768px) {
            #navbar {
                padding: 15px 5px; 
            }
            #landing h1 {
                font-size: 2.5rem;
            }
            #landing p {
                font-size: 1rem;
                padding: 0 20px;
            }
            .key-stats {
                flex-direction: column;
                gap: 20px;
            }
            #dashboard, #metrics, #about {
                padding: 100px 20px 20px 20px;
            }
            .kpi-grid {
                grid-template-columns: 1fr;
            }
            .chart-wrapper {
                height: 300px; /* Adjust height for mobile */
            }
        }
    </style>
</head>

<body>
    <nav id="navbar">
        <div class="logo">DexSight</div>
        <div id="nav-links-container">
            <a href="#" class="nav-link" id="nav-home-link">Home</a>
            <a href="#dashboard" class="nav-link" id="nav-dashboard-link">Dashboard</a>
            <a href="#metrics" class="nav-link" id="nav-metrics-link">Metrics</a>
            <a href="#about" class="nav-link" id="nav-about-link">About</a>
        </div>
    </nav>

    <!-- LANDING SECTION -->
    <section id="landing" class="page-section">
        <div class="bg-animation"></div>

        <h1 class="fade-slide">Refining the Future of Arbitrage Intelligence.</h1>
        <p class="fade-slide delay1">
            Experience real-time arbitrage monitoring across Polygonâ€™s leading DEXs.
Our next-generation intelligence engine delivers ultra-low-latency insights, empowering you with instant, data-driven decisions â€” all from a single, intuitive dashboard.
        </p>

        <button id="open-dashboard" class="fade-slide delay2">View Live Opportunities â†’</button>

        <div class="key-stats fade-slide delay3">
            <div class="stat-item">
                <h3>1,200+</h3>
                <p>Opportunities Detected</p>
            </div>
            <div class="stat-item">
                <h3>0.14s</h3>
                <p>Average Latency</p>
            </div>
            <div class="stat-item">
                <h3>$1.5M+</h3>
                <p>Potential Profit Monitored</p>
            </div>
        </div>

        <footer class="fade-slide delay4">
            Powered by Rust and Ethers.rs â€” Data is for informational purposes only.
        </footer>
    </section>

    <!-- DASHBOARD SECTION -->
    <section id="dashboard" class="page-section">
        <h2>Real-Time Opportunity Stream</h2>
        <table id="opportunities" class="display">
            <thead>
                <tr>
                    <th>Timestamp</th>
                    <th>Buy DEX</th>
                    <th>Sell DEX</th>
                    <th>Amount In (USDC)</th>
                    <th>Profit (USDC)</th>
                    <th>Gas (Gwei)</th>
                    <th>Block</th>
                </tr>
            </thead>
        </table>

        <!-- The Bubble Chart for individual transactions is here -->
        <canvas id="profitChart"></canvas>

        <footer style="text-align:center;margin-top:20px;color:#94a3b8;">
            ðŸ”„ Real-Time Feed | Arbitrage Intelligence Monitor
        </footer>
    </section>

    <!-- METRICS SECTION (FIXED) -->
    <section id="metrics" class="page-section">
        <div class="bg-animation"></div>
        <div class="metrics-container">
            <h2 class="fade-slide">Aggregate Performance Metrics</h2>

            <div class="kpi-grid fade-slide delay1">
                <div class="kpi-card">
                    <div class="value" id="kpi-total-profit">$15,245</div>
                    <div class="label">Total Profit (USDC)</div>
                </div>
                <div class="kpi-card">
                    <div class="value" id="kpi-success-rate">95.2%</div>
                    <div class="label">Opportunity Success Rate</div>
                </div>
                <div class="kpi-card">
                    <div class="value" id="kpi-txns">1,892</div>
                    <div class="label">Total Transactions</div>
                </div>
                <div class="kpi-card">
                    <div class="value" id="kpi-avg-profit">$8.05</div>
                    <div class="label">Average Profit Per Txn</div>
                </div>
            </div>

            <div class="fade-slide delay2">
                <h3>Cumulative Profit Over Time (7-Day Trend)</h3>
                <!-- THE FIX: This wrapper has a fixed height (450px in CSS) -->
                <div class="chart-wrapper"> 
                    <canvas id="cumulativeProfitChart"></canvas>
                </div>
            </div>

        </div>
    </section>
    
    <!-- ABOUT SECTION -->
    <section id="about" class="page-section">
        <div class="bg-animation"></div>
        <div class="about-container">
            <h2 class="fade-slide">About DexSight: Polygon Arbitrage Bot Monitor</h2>

            <div class="about-item fade-slide delay1">
                <h3>What We Do</h3>
                <p>
                    DexSight Arbitrage Bot is a real-time cryptocurrency arbitrage monitoring platform designed to identify profitable trading opportunities across decentralized exchanges (DEXs) on the Polygon network.
                </p>
            </div>

            <div class="about-item fade-slide delay2">
                <h3>Why We Built It</h3>
                <p>
                    The platform helps traders and developers monitor price differences across multiple liquidity pools, enabling efficient arbitrage strategies and better market analysis. It aims to increase market transparency and efficiency.
                </p>
            </div>

            <div class="about-item fade-slide delay3">
                <h3>The Engine Inside</h3>
                <p>
                    The bot continuously scans decentralized exchanges on Polygon (like QuickSwap and Uniswap V3), compares token prices, and highlights opportunities where price discrepancies can yield profit. The dashboard updates automatically in real time, providing live insights and profit visualizations.
                </p>
            </div>

            <div class="about-item fade-slide delay4">
                <h3>Powerful Features</h3>
                <ul>
                    <li> Live arbitrage opportunity tracking</li>
                    <li> Profit visualization with interactive charts (Bubble Chart)</li>
                    <li> Secure, non-custodial data access</li>
                    <li> Built on the fast and scalable Polygon blockchain</li>
                </ul>
            </div>
            
            <div class="about-item fade-slide delay5">
                <h3>Where Weâ€™re Headed</h3>
                <p>
                    Our goal is to make blockchain data analysis and arbitrage monitoring more transparent, accessible, and efficient for everyone in the DeFi ecosystem.
                </p>
            </div>

        </div>
    </section>


    <script>
        // Constants for DEX information
        const DEX_LINKS = {
            "A": { name: "QuickSwap", url: "https://quickswap.exchange/#/swap" },
            "B": { name: "Uniswap V3", url: "https://app.uniswap.org/#/swap" },
        };

        function getDexInfo(dexLetter) {
            if (dexLetter === 'A') return DEX_LINKS['A'];
            if (dexLetter === 'B') return DEX_LINKS['B'];
            return { name: dexLetter, url: '#' };
        }

        let profitChart;
        let cumulativeProfitChart; // New chart variable
        let table; // Reference to the DataTable instance
        let isTableInitialized = false;

        // Function to manage all section visibility
        function showSection(sectionId) {
            document.querySelectorAll('.page-section').forEach(section => {
                section.style.display = 'none';
            });

            const targetSection = document.getElementById(sectionId);
            if (targetSection) {
                // Landing and About use 'flex' (for centering), Dashboard and Metrics use 'block' (for width control)
                const displayType = (sectionId === 'dashboard' || sectionId === 'metrics' ? 'block' : 'flex');
                targetSection.style.display = displayType;
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }

            // Adjust navbar background and run specific initializers
            if (sectionId === 'dashboard' || sectionId === 'metrics' || sectionId === 'about') {
                document.getElementById('navbar').style.backgroundColor = 'rgba(8, 10, 14, 0.9)';
                if (sectionId === 'dashboard') initTable();
                // Initialize the cumulative chart only when entering the metrics section
                if (sectionId === 'metrics') initCumulativeChart(); 
            } else { // landing
                document.getElementById('navbar').style.backgroundColor = 'rgba(14, 18, 25, 0.8)';
            }
        }

        // Navigation handlers
        document.getElementById("open-dashboard").addEventListener("click", () => showSection('dashboard'));
        document.getElementById("nav-dashboard-link").addEventListener("click", (e) => {
            e.preventDefault();
            showSection('dashboard');
        });
        document.getElementById("nav-home-link").addEventListener("click", (e) => {
            e.preventDefault();
            showSection('landing');
        });
        document.getElementById("nav-about-link").addEventListener("click", (e) => {
            e.preventDefault();
            showSection('about');
        });
        // Handler for Metrics link
        document.getElementById("nav-metrics-link").addEventListener("click", (e) => {
            e.preventDefault();
            showSection('metrics');
        });


        // Function to initialize the Cumulative Profit Chart (Line Chart for Metrics)
        function initCumulativeChart() {
            const ctx = document.getElementById('cumulativeProfitChart').getContext('2d');
            // Crucial: Destroy the old chart instance to prevent memory leaks and layout issues
            if (cumulativeProfitChart) {
                cumulativeProfitChart.destroy();
            }
            
            // Mock data for cumulative profit trend
            const labels = ['Day 1', 'Day 2', 'Day 3', 'Day 4', 'Day 5', 'Day 6', 'Day 7'];
            const data = [1500, 3100, 5800, 8500, 11000, 13500, 15245];

            cumulativeProfitChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Cumulative Profit (USDC)',
                        data: data,
                        backgroundColor: 'rgba(46, 204, 113, 0.1)',
                        borderColor: '#2ecc71',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.3,
                        pointRadius: 5,
                        pointBackgroundColor: '#7f5af0'
                    }]
                },
                options: {
                    responsive: true,
                    // IMPORTANT FIX: Setting this to false or undefined is key 
                    // when the container has a fixed height, preventing the canvas from trying to maintain a 1:1 ratio.
                    maintainAspectRatio: false, 
                    plugins: {
                        legend: { display: false },
                        title: {
                            display: true,
                            text: '7-Day Cumulative Profit Trend',
                            color: '#e4e7eb',
                            font: { size: 16, weight: 'bold' }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'Profit: $' + context.parsed.y.toLocaleString();
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { color: '#1f2a37' },
                            ticks: { color: '#94a3b8' }
                        },
                        y: {
                            beginAtZero: true,
                            grid: { color: '#1f2a37' },
                            ticks: { 
                                color: '#94a3b8',
                                callback: function(value) { return '$' + value.toLocaleString(); }
                            }
                        }
                    }
                }
            });
        }


        // Function to initialize the Data Table and Bubble Chart
        function initTable() {
            // Only initialize DataTable once
            if (!isTableInitialized) {
                 table = $('#opportunities').DataTable({
                    // Mock AJAX URL - assumes a server/API is running to supply data
                    ajax: {
                        url: '/opportunities',
                        dataSrc: '',
                        error: function (xhr, status, error) {
                            console.error("DataTables Ajax error:", status, error);
                            // Custom error display instead of alert()
                            $('#opportunities_wrapper').html('<p style="color: red; text-align: center;">Error loading data. Check if the Rust server is running and the API endpoint is correct.</p>');
                        }
                    },
                    columns: [
                        { data: 'timestamp', render: d => `<span style="color:#94a3b8">${new Date(d).toLocaleString()}</span>` },
                        {
                            data: 'dex_buy',
                            render: d => {
                                const dex = getDexInfo(d);
                                return `<a href="${dex.url}" target="_blank" style="color: #7f5af0; text-decoration: none;">${dex.name}</a>`;
                            }
                        },
                        {
                            data: 'dex_sell',
                            render: d => {
                                const dex = getDexInfo(d);
                                return `<a href="${dex.url}" target="_blank" style="color: #7f5af0; text-decoration: none;">${dex.name}</a>`;
                            }
                        },
                        { data: 'amount_in', render: d => parseFloat(d).toFixed(2) + ' $' },
                        {
                            data: 'profit',
                            render: d => {
                                const profit = parseFloat(d);
                                return `<span class="${profit > 0 ? 'profit-positive' : 'profit-negative'}">${profit.toFixed(4)} $</span>`;
                            }
                        },
                        {
                            data: 'gas_price_gwei',
                            render: d => {
                                const gas = parseFloat(d);
                                return `<span style="color:#f9a825">${!isNaN(gas) ? gas.toFixed(2) : 'N/A'}</span>`;
                            }
                        },
                        {
                            data: 'block_number',
                            render: d => `<span style="color:#5dade2">${d !== undefined ? d : '---'}</span>`
                        }
                    ],
                    order: [[0, 'desc']],
                    pageLength: 10,
                    responsive: true,
                    dom: 'lfrtip'
                });
                isTableInitialized = true;

                const ctx = document.getElementById('profitChart').getContext('2d');
                if (profitChart) {
                    profitChart.destroy(); // Destroy old chart instance if it exists
                }
                
                // Initialize the new Bubble Chart
                profitChart = new Chart(ctx, {
                    type: 'bubble', 
                    data: {
                        labels: ['Transaction Index'],
                        datasets: [{
                            label: 'Transaction Profit (Bubble Size = Volume)',
                            backgroundColor: 'rgba(127, 90, 240, 0.5)', 
                            borderColor: '#7f5af0',
                            borderWidth: 2,
                            data: []
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { 
                                display: true, 
                                labels: {
                                    color: '#e4e7eb', 
                                    font: { size: 14 }
                                }
                            },
                            title: {
                                display: true,
                                text: 'Profit vs. Volume for Last 20 Transactions',
                                color: '#e4e7eb',
                                font: { size: 16, weight: 'bold' }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        const data = context.dataset.data[context.dataIndex];
                                        const profit = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(data.y);
                                        const volume = data.volume.toLocaleString('en-US', { maximumFractionDigits: 2 }) + ' USDC';

                                        return [
                                            `Index: ${data.x}`,
                                            `Profit: ${profit}`,
                                            `Volume: ${volume}`
                                        ];
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                grid: { color: '#1f2a37' },
                                ticks: { 
                                    color: '#94a3b8',
                                    stepSize: 1
                                },
                                min: 0,
                                max: 21,
                                title: { display: true, text: 'Transaction Index (1 = Oldest, 20 = Newest)', color: '#7f5af0' }
                            },
                            y: {
                                grid: { color: '#1f2a37' },
                                ticks: { 
                                    color: '#94a3b8',
                                    callback: function(value) { return '$' + value.toLocaleString(); }
                                },
                                title: { display: true, text: 'Profit (USDC)', color: '#7f5af0' }
                            }
                        }
                    }
                });

                // Set interval to reload data and update chart
                setInterval(() => {
                    // Only reload if the dashboard is currently visible
                    if (document.getElementById("dashboard").style.display === "block" && isTableInitialized) {
                        table.ajax.reload(updateChart, false);
                    }
                }, 4000);

            } else {
                // If already initialized, just reload the data and update the chart
                table.ajax.reload(updateChart, false);
            }
        }

        // New updateChart function for the Bubble Chart
        function updateChart(json) {
            if (!json || !profitChart) return;
            
            // 1. Sort to get the most recent data
            const sortedJson = [...json].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            // 2. Get the last 20 transactions
            const recentOpportunities = sortedJson.slice(0, 20).reverse(); 
            
            const newChartData = [];
            const newColors = [];

            // Determine max volume for scaling
            const maxAmountIn = Math.max(...recentOpportunities.map(o => parseFloat(o.amount_in || 0)));
            const baseRadius = 5;

            recentOpportunities.forEach((o, index) => {
                const profit = parseFloat(o.profit || 0);
                const amountIn = parseFloat(o.amount_in || 0);
                
                // Scaling the radius: Base size + scaled volume (using log for non-linear scaling)
                const scaledRadius = baseRadius + (amountIn > 0 ? (Math.log10(amountIn + 1) / Math.log10(maxAmountIn + 1)) * 15 : 0);

                newChartData.push({
                    x: index + 1, // X: Transaction Index
                    y: profit,    // Y: Profit
                    r: scaledRadius, // R: Radius (Volume)
                    volume: amountIn 
                });

                // Color based on profit
                newColors.push(profit > 0
                    ? 'rgba(46, 204, 113, 0.8)' // Green for Profit
                    : 'rgba(231, 76, 60, 0.8)' // Red for Loss
                );
            });

            // Update the chart dataset
            profitChart.data.datasets[0].data = newChartData;
            profitChart.data.datasets[0].backgroundColor = newColors;
            profitChart.update();
        }
        
        // Particle generation logic
        const numParticles = 100;
        
        function generateParticlesForSection(selector) {
            const container = document.querySelector(selector);
            if (!container || container.dataset.particlesGenerated) return;

            for (let i = 0; i < numParticles; i++) {
                const p = document.createElement('div');
                p.classList.add('particle');
                // Randomize starting position and animation properties
                p.style.left = Math.random() * 100 + '%';
                p.style.top = Math.random() * 100 + '%';
                p.style.animationDelay = Math.random() * 20 + 's';
                p.style.animationDuration = 15 + Math.random() * 15 + 's';
                container.appendChild(p);
            }
            container.dataset.particlesGenerated = true; // Mark as generated
        }
        
        // Generate particles for all relevant pages on load
        window.onload = function() {
            generateParticlesForSection('#landing');
            generateParticlesForSection('#about');
            generateParticlesForSection('#metrics'); 
            showSection('landing'); // Initialize to the landing page
        }
        
    </script>
</body>
</html>